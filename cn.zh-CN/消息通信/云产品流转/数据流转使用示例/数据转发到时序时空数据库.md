---
keyword: [物联网, 物联网平台, IoT, 规则引擎, 流转数据, 发送数据, 时序时空数据库（TSDB）]
---

# 数据转发到时序时空数据库

您可以配置数据流转规则，将处理过的数据转发到时序时空数据库（TSDB）的实例中存储。

-   已在华东2（上海）地域创建专有网络下的TSDB实例。TSDB使用方法，请参见[时序时空数据库（TSDB）文档](https://help.aliyun.com/product/54825.html)。
-   已创建数据转发规则和编写处理数据的SQL，请参见[设置数据流转规则](/cn.zh-CN/消息通信/云产品流转/设置数据流转规则.md)。

## 限制说明

-   仅支持同地域转发。例如：华东2（上海）的物联网平台实例数据只能转发到华东2（上海）的TSDB实例中。
-   仅支持转发到专有网络（VPC）下的TSDB实例。
-   仅支持转发JSON格式数据。
-   不支持时序数据库InfluxDB版。
-   不支持时空数据库。
-   转发的消息中，除了配置为timestamp和tag值的字段外，其他字段都将作为metric写入时序时空数据库。metric的值只能为数值类型，否则会导致写入数据库失败。

## 操作步骤

1.  登录[物联网平台控制台](http://iot.console.aliyun.com/)。

2.  在左侧导航栏，选择**规则引擎** \> **云产品流转**。

3.  单击规则对应的**查看**，进入数据流转规则页。

4.  单击**转发数据**一栏对应的**添加操作**。

5.  在添加操作对话框中，选择操作为**存储到时序时空数据库（TSDB）中**。按照界面提示，设置其他信息，单击**确认**。

    |参数|描述|
    |:-|:-|
    |选择操作|选择**存储到时序时空数据库（TSDB）中**。|
    |地域|固定为您的物联网平台实例所在地域。|
    |TSDB实例|选择数据转发目标为您已创建的专有网络（VPC）下的TSDB实例。|
    |timestamp|时间戳。支持：     -   使用转义符`${}`表达式，例如`${time}`，表示取值为数据源Topic消息中time字段对应的值。
    -   使用数据流转函数`timestamp()`，表示取值为数据流转服务器的时间戳。
    -   输入值，必须为Unix时间戳，例如1404955893000。 |
    |tag|设置标记数据的标签名。支持中文汉字、英文字母、数字和特殊字符，包括：半角冒号（:）、逗号（,）、点号 （.）、单引号（'）、正斜线（/）、短划线（-）、下划线（\_）、圆括号\(\)、方括号\[\]。|
    |值|设置标签值。支持：     -   使用转义符`${}`表达式。例如，数据源Topic的消息结构中，包含一个位置属性，标识符为city，则可以指定标签值为`${city}`，表示消息中city字段对应的值。建议使用此方式。
    -   使用数据流转函数规定的一些函数，例如`deviceName()`，表示标签值为设备名称。支持的函数，请参见[函数列表](/cn.zh-CN/消息通信/云产品流转/函数列表.md)。
    -   输入常量，例如beijing。支持输入中文汉字、英文字母、数字和特殊字符，包括：半角冒号（:）、逗号（,）、点号 （.）、单引号（'）、正斜线（/）、短划线（-）、下划线（\_）、圆括号\(\)、方括号\[\]。
**说明：**

    -   最多可添加8个tag键值对。
    -   需保证TSDB能够获取到配置的tag键值对，如果获取不到任意一个tag键值对，会导致写入数据库失败。 |
    |角色|授权物联网平台将数据写入TSDB。 物联网平台会向TSDB实例中添加网络白名单，用于物联网平台访问您的TSDB数据库， 请勿删除这些IP段。

若TSDB实例白名单中未出现物联网平台IP：100.104.76.0/24，请手动添加。 |

6.  回到云产品流转页，单击规则对应的**启动**按钮启动规则。


## 数据流转示例

某规则的SQL如下：

```
SELECT time,city,power,distance FROM "/alprodu****/myDevice/user/update"；
```

规则引擎根据SQL处理数据和写入数据到TSDB如下。

1.  根据该SQL，规则引擎从Topic `/alprodu****/myDevice/user/update`的消息中，筛选出time、city、power、和distance字段内容，作为转发的消息内容。

    通过以上SQL处理后的转发消息内容示例如下：

    ```
    {
    "time": 1513677897,
    "city": "beijing",
    "distance": 8545,
    "power": 93.0
    }
    ```

2.  根据已配置的数据流转操作，规则引擎向TSDB中写入的两条数据。

    示例中写入TSDB的数据如下：

    -   ```
数据: timestamp:1513677897, [metric:power value:93.0]
tag: cityName=beijing
```

    -   ```
数据: timestamp:1513677897, [metric:distance value:8545]
tag: cityName=beijing
```

    写入TSDB的数据说明：

    以上转发的消息中，除了配置为timestamp的time字段和配置为tag值的city字段外，其他字段（power和distance）都作为metric写入时序时空数据库。


## 操作样例

[通过TSDB实现楼宇环境监测](/cn.zh-CN/最佳实践/场景应用/通过TSDB实现楼宇环境监测.md)

